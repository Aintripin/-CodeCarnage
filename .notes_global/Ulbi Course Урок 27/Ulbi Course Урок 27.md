У нас дохуя скриптов:

> `package.json`:

![[Pasted image 20241106120901.png]]

Запускать вручную становится неудобно 

Процесс запуска хочется автоматизировать

### Потоэтому мы щас с помощью `github actions` будем настраивать CI/CD

### Но пока только CI



### Короче, вот скрипты:

![[Pasted image 20241106163119.png]]

Их всех нужно бы запускать для проверки, то всё хорошо перед push'ом, особенно в `master` 

Опять-таки, их дохуя. Запускать руками - чё-то такое себе 

Поэтому мы сейчас ёбнем (будем настравить) `github actions`

Для этого в самом корне проекта создадим:

![[Pasted image 20241106163302.png]]


## Чё и как делать берём из [документации](https://docs.github.com/en/actions/writing-workflows/quickstart)

Терь внутри самой папки создадим файл с расширением `.yaml`. Имя файла может быть любое

Мы назовём вот так:

![[Pasted image 20241106163940.png]]

Терь вставляем в него инфу из шага 2:

![[Pasted image 20241106164018.png]]

WS предложит установить плагин:

![[Pasted image 20241106164055.png]]

Но мы забиваем хуй


### Щас попробуем этот `.yaml` файл запушить в github


Зайдём на github, откроем репозиторий 

И чё-то по типу такого будет:

![[Pasted image 20241106164240.png]]

![[Pasted image 20241106164250.png]]

Щас если нажать на `Details`:

![[Pasted image 20241106164339.png]]

То мы увидим те самые `action`'ы, которые мы настроили

![[Pasted image 20241106164423.png]]

Щас скрипты у нас простые, но они могут быть и сложные и может их быть дохера. В общем, настройкой этого всего мы щас и займёмся

Поменяем вот эту часть:

![[Pasted image 20241106164601.png]]

Терь разберёмся с jobs:

![[Pasted image 20241106164702.png]]


Создадим поле `pipeline`. В поле `runs-on` указываем OS, на которой будут запускаться все проверки

![[Pasted image 20241106164930.png]]

Касательно `steps`:
мы устанавливаем на машину, на которой будут запускаться проверки нужную версию NodeJS

![[Pasted image 20241106165028.png]]

`node-version` мы получаем, как переменную

И тут мы подошли к моменту, когда мы можем запускать свои скрипты. Первое, что нужно сделать - установить node module'и 

![[Pasted image 20241106165209.png]]


![[Pasted image 20241106165308.png]]

При грамотной настройке все эти проверки можно распараллелить. Сейчас они у нас будут идти последовательно

Но, т.к. мы хуесосы, мы делаем самую простую варицаию

Идея, вообще, какая:

![[Pasted image 20241106165425.png]]

Из `package.json` тупо в `main.yml`-файл

> `main.yml`:

![[Pasted image 20241106165826.png]]

У нас остаётся SB и UI-тесты, последние потребуют немного другой настройки. Так что пока хуярим в github так

#### И щас, если перейти на github, можно увидеть:

![[Pasted image 20241106170000.png]]

Что чё-то происходит. В консоли там под самими тестами логи

Щас у нас:

![[Pasted image 20241106170058.png]]

запустился WP bundle analyzer

Процесс бесконечный, он не завершается

По такой причине, для `production`-сборки, нам `bundle analyzer` надо отключить



Перейдём в файл `buildPlugins.ts`:

Тут у нас есть флаг `isDev`

Создадим массив плагинов

![[Pasted image 20241106170411.png]]

По умолчанию добавим в него всё, что ниже в `return`, т.е. вот так:

![[Pasted image 20241106170601.png]]

Но вырежем те, которые нужны только для разработки. Это вот эти два:

![[Pasted image 20241106170715.png]]

![[Pasted image 20241106172842.png]]

Вот эти плагины с помощью метода `push` добавим

![[Pasted image 20241106172927.png]]

Терь вот эти два плагина - их нужно делать по условию:

![[Pasted image 20241106173115.png]]

Т.е. при `production` сборке этих плагинов не будет. И запускаться `bundle analyzer` 

Щас ёбнем это в github

![[Pasted image 20241106174339.png]]



В `github actions` поехало:

![[Pasted image 20241106174424.png]]


Щас бесконечно не висит, сборка прошла успешно

![[Pasted image 20241106174446.png]]

Но на linting'е ёбнулось

У нас в sidebar:

![[Pasted image 20241106174546.png]]

`i18n` плагин ругается

Короче, вот у нас кнопка:

![[Pasted image 20241106174630.png]]

Она без перевода

На текущее время просто закоментируем:

![[Pasted image 20241106174720.png]]

Чтобы не ругалось


Терь опять закоммитим всё и отправим на github

Щас упали unit-тесты:

![[Pasted image 20241106174847.png]]

Это как раз-таки из-за закомментирования кнопки с переводом

В итоге, вернёмся в:

> `Sidebar.tsx`:

![[Pasted image 20241106175115.png]]


Терь так:

![[Pasted image 20241106175148.png]]


### Предлагается создать pull request и посмотреть как оно всё отработает

```BASH:
git checkout -b fix_toggle_btn
```

Ветку мы сменили и теперь ёбнем:

```BASH:
git add .
git commit -m ""
git push origin fix_toggle_btn
```

В `pull requests`:

![[Pasted image 20241106175505.png]]


![[Pasted image 20241106175515.png]]

![[Pasted image 20241106175540.png]]

Потом нажмём `create pull request`

#### Вообще, должны были запуститься `github actions` на создание pull request'а. Но, почему-то, они не запустились

У него ошибка была в `main.yml` файле в названии ветки:

![[Pasted image 20241106175729.png]]

Было `maser` вместо `master`


В этот момент всё прошло успешно



Таким образом мы убедились, что код, который мы написали для своей задачи в нашей ветке не ломает всё приложение


Терь свичнемся обратно на ветку `master` и подгрузим изменения, которые мы сделали на ветке `fix_toggle_btn`

Либо:

```BASH:
git pull
```

Либо вот этой кнопкой:

![[Pasted image 20241106180205.png]]

![[Pasted image 20241106180325.png]]

Т.к. мы единственные разрабы, то можно сделать любое: либо `merge`, либо `rebase`



### Часть проекта мы автоматизировали, но остались UI-тесты и сборка SB

### В документации Loki есть вот такая тема:

![[Pasted image 20241106180503.png]]

Тут показано, как запускать Loki в CI-pipeline'е 

Сначала делаем:

```BASH:
npm run storybook:build
```

И уже на основании этой сборки мы можем делать снятие скриншотов

Т.е. сам SB запускать необязательно 

Любую сборку мы добавляем в `.gitingnore`

Поэтому:

![[Pasted image 20241106180758.png]]

Теперь, согласно документации, мы теперь указываем путь до статики, которую собрал SB

![[Pasted image 20241106180955.png]]


Терь ёбнем:

```BASH:
npm run test:ui:ci
```

Чё-то ёбнулось:

![[Pasted image 20241106181055.png]]

#### Посмотрим, как это будет работать в CI

Добавим эти скрипты в yaml-файл

![[Pasted image 20241106181209.png]]


На github видим, что сборка прошла успешно и тесты тоже:

![[Pasted image 20241106181313.png]]

Но, при этом упали скрины для `Sidebar`, потому что мы изменили там кнопку


```BASH:
npm run test:ui
```

Видим в папке `difference`:

![[Pasted image 20241106181421.png]]

Т.е. мы изменили текст - содержимое кнопки и всё ёбнулось

Если содержимое компонента сложное, то по таким скринам понять, что изменилось будет проблематично


#### В документации Loki можно найти примеры различных движков, которые сравнивают изображения:

![[Pasted image 20241106181545.png]]

Вот это:

![[Pasted image 20241106181629.png]]

из документации копируем в конфигурацию

```BASH:
npm run test:ui
```

Но щас у нас выглядит всё точно также:

![[Pasted image 20241106181731.png]]

Тогда это (то, что скопировали только что) из документации удалим

Терь выполним:

```BASH:
npm test:ui:ok
```

Чтобы эти скрины подтвердить



UPD: короче после двухдневных танцев с бубном вот так:

![[Pasted image 20241107165528.png]]
