Щас будем ебашить скриншотные тесты, чтобы понять, нахуя нам вообще этот SB нужен

Существует множество тестов, с помощью которых можно снимать скриншоты. Есть платные, есть бесплатные 

Мы будем ебашить через:

### Loki

Сначала ебанём это, как dev-зависимость:

```BASH:
npm i -D loki@0.28.1
```

Терь мы ёбнем:

```BASH:
npx loki init
```

Там на сайте пример с yarn'ом, но т.к. мы хуесосы с `npm`, то в нашем случае это `npx`

У нас щас всё наебнётся с ошибкой:

![[Pasted image 20241105150741.png]]

Потому что мы переместили конфигурацию SB'ка из корня проекта и оно до этой конфигурации найти путь не может. Поэтому делаем вот так:

```BASH:
npx loki init --config ./config/storybook
```

Терь у нас:

> `package.json`:

![[Pasted image 20241105150945.png]]

Лежит вот такая конфигурация

Скрины мы будем снимать для ноутбука на Chrome'е и для iPhone (тоже Chrome)


#### Терь, чтобы с Loki начать работать, нам необходимо запустить SB:

```BASH:
npm run storybook
```

Чтобы SB запустился, мы можем начинать скриншотное тестирование. Для этого, следуя документации, необходимо ёбнуть:

```BASH:
npx loki test
```

Имеем:

![[Pasted image 20241105151233.png]]

Ругается на то, что не удаётся запустить docker-образ

Всё дело в том, что в конфигурации в качестве target'а у нас указан docker:

![[Pasted image 20241105151327.png]]


На [официальном сайте](https://loki.js.org/getting-started.html):

![[Pasted image 20241105151655.png]]

Если сюда нажмём, нас ёбнет на:

```URL:
https://www.docker.com/pricing/#/download
```

А если не нажмём, не ёбнет

Нам нажимать не нужно, потому что нас интересует, как альтернатива, вот это:

![[Pasted image 20241105151823.png]]

Т.е. в качестве таргета `chrome.app` и указываем:

> `package.json`:

![[Pasted image 20241105161916.png]]

Ёбнем ещё раз:

```BASH:
npx loki test
```

Будет вот так, т.е. пойдёт тестирование:

![[Pasted image 20241105162038.png]]

Но оно опять ёбнется:

![[Pasted image 20241105162229.png]]

Перейдём в папку `node_modules`, там найдём пакет `loki`:

![[Pasted image 20241105162208.png]]


Внутри `./loki` папка `./target-chrome-app`, далее `./src`, там файл `create-chrome-app-target.js`:

> `create-chrome-app-target.js`:

![[Pasted image 20241105162442.png]]

Тут есть функция `start`

Тут ещё запускается chrome, есть URL и прочие настройки

Вот такая хуйня есть:

![[Pasted image 20241105162546.png]]

Это, как мы тут видим:

![[Pasted image 20241105162616.png]]

Сторонняя библиотека

##### Можем сделать следующий эксперимент:

![[Pasted image 20241105162724.png]]

Терь, если ёбнем:

```BASH:
npx loki test
```

![[Pasted image 20241105162834.png]]



![[where_finish_v000.png]]

Возможно, если настройки винды какие-то другие, то там всё будет ОК

Короче, на github'е он созда issue:

![[Pasted image 20241105163431.png]]

Т.е. проблема в Google Chrome Launcher

Короче, если нихуя не работает и с вот таким target'ом:

![[Pasted image 20241105163638.png]]

loki не запускается, то ставим обратно на:

![[Pasted image 20241105163936.png]]


### В таком случае придётся ставить Docker

Короче, как лично у меня получилось:

В корне проекта создаём файл `Dockerfile` (прям так, без расширения) (корень - это не папка `./src`, а именно the parent folder)

>`Dockerfile`:

```
FROM node:14-alpine  
  
WORKDIR /app  
  
COPY package*.json ./  
RUN npm ci  
  
COPY . .  
  
CMD ["npm", "start"]
```

Далее ебашим вот так:

```BASH:
npm run storybook
```

Запускается вот это:

![[Pasted image 20241106114051.png]]

Далее ебашим: 

```BASH:
npx loki test
```

Имеем:

![[Pasted image 20241106114236.png]]

Магия, блядь!

![[screen-shot-2020-05-20-at-12.20.07-pm-e1590002440644.webp]]

Я хуй знает как и почему это работает, но оно это делает. Кстати, в самом docker'е вот такие билды:

![[Pasted image 20241106114429.png]]

![[Pasted image 20241106114440.png]]

После того, как мы запустили Docker у ся на компе, мы выполняем:

```BASH:
npx loki test
```

Чё-то пошло:

![[Pasted image 20241105164505.png]]

Прошло успешно:

![[Pasted image 20241105164525.png]]

После того, как тесты выполнились, у нас в проекте появляется папка `loki`:

![[Pasted image 20241105164831.png]]

В ней лежит хуева туча скринов:

![[Pasted image 20241105164855.png]]

Это скриншоты компонентов. Тут есть ссылки, страницы, sidebar... - всё, что добавляли

Причём в двух вариантах - с дексктопа и мобильного бразуера


### Терь хули с этим делать

##### Откроем компонент, например, Navbar:

![[Pasted image 20241105165151.png]]

Вот щас у нас стили такие:

![[Pasted image 20241105165221.png]]

Можем поменять цвет заднего фона. Сделаем его красным:

![[Pasted image 20241105165253.png]]

Теперь запустим тесты ещё раз:

```BASH:
npx loki test
```

Видим:

![[Pasted image 20241105165328.png]]

что часть тестов прошла успешно, а часть нет

![[Pasted image 20241105165357.png]]

Всё дело в том, что новые скрины - новый UI, он начинается сркавниваться со старым

Он видит, что изменился цвет заднего фона

![[Pasted image 20241105165445.png]]

Это нужно для того, что, если мы сломаем где-то вёрстку, то Loki это заметит и подсветит и мы предотвратим какой-нить баг

#### Это и есть `регресионное тестирование`

 Т.е. это когда мы убеждаемся в том, что новый функционал не сломал старый

Вернём обратно цвет фона:

> `Navbar.module.scss`:

![[Pasted image 20241105165631.png]]



### Мы щас подготовили всё к тестированию, но не добавили главного - скрипты, чтобы эти тесты сами запускать. Надо исполнить

>`package.json`:

Вот эту строчку:

![[Pasted image 20241105170003.png]]

Заменим на:

![[Pasted image 20241105170026.png]]

Чтобы было всё единообразно



У нас ещё есть команда, которая запускает `unit`-тесты:


![[Pasted image 20241105170105.png]]

Добавим приставку `test`:


![[Pasted image 20241105170129.png]]

Чтобы было симантически понятно

Тоже самое сделаем и для скриншотных тестов (это новая линия, продублировали старую и изменили):

![[Pasted image 20241105170232.png]]


Ещё добавим скрипт, с помощью которого мы скрины будем одобрять 

![[Pasted image 20241105170314.png]]

Это скрипт на случай, когда loki отловил ождиаемые изменения

Т.е. он осознанно что-то поймал и мы эти изменений подтвердили